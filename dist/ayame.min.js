!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Ayame={})}(this,function(e){"use strict";function t(e,t){let n="";n="VP8"===e?"video/VP8":"VP9"===e?"video/VP9":"H264"===e?"video/H264":`video/${e}`;const a=t.filter(e=>e.mimeType==n);if(a.length<1)throw new Error("invalid video codec type");return a}function n(){const e=window.navigator.userAgent.toLocaleLowerCase();return-1!==e.indexOf("edge")?"edge":-1!==e.indexOf("chrome")&&-1===e.indexOf("edge")?"chrome":-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")?"safari":-1!==e.indexOf("opera")?"opera":-1!==e.indexOf("firefox")?"firefox":void 0}class a{on(e,t){e in this._callbacks&&(this._callbacks[e]=t)}constructor(e,t,n,a=!1){this.debug=a,this.roomId=t,this.signalingUrl=e,this.options=n,this._removeCodec=!1,this.stream=null,this.remoteStream=null,this._pc=null,this.authnMetadata=null,this.authzMetadata=null,this._dataChannels=[],this._isOffer=!1,this.connectionState="new",this._callbacks={open:()=>{},connect:()=>{},disconnect:()=>{},addstream:()=>{},removestream:()=>{},data:()=>{}}}async _disconnect(){await this._dataChannels.forEach(async e=>{await this._closeDataChannel(e)}),await this._closePeerConnection(),await this._closeWebSocketConnection(),this.stream&&this.stream.getTracks().forEach(e=>{e.stop()}),this.remoteStream&&this.remoteStream.getTracks().forEach(e=>{e.stop()}),this.remoteStream=null,this.stream=null,this.authnMetadata=null,this.authzMetadata=null,this._ws=null,this._pc=null,this._removeCodec=!1,this._isOffer=!1,this._dataChannels=[],this.connectionState="new"}async _signaling(){return new Promise((e,t)=>{if(this._ws)return t("WS-ALREADY-EXISTS");this._ws=new WebSocket(this.signalingUrl),this._ws.onclose=async()=>(await this._disconnect(),t("WS-CLOSED")),this._ws.onerror=async()=>(await this._disconnect(),t("WS-CLOSED-WITH-ERROR")),this._ws.onopen=()=>{const n={type:"register",roomId:this.roomId,clientId:this.options.clientId,authnMetadata:void 0};null!==this.authnMetadata&&(n.authnMetadata=this.authnMetadata),this._sendWs(n),this._ws&&(this._ws.onmessage=async n=>{try{if("string"!=typeof n.data)return;const a=JSON.parse(n.data);if("ping"===a.type)this._sendWs({type:"pong"});else if("close"===a.type)this._callbacks.close(n);else{if("accept"===a.type)return this.authzMetadata=a.authzMetadata,this._pc||this._createPeerConnection(),await this._sendOffer(),e();if("reject"===a.type)return await this._disconnect(),this._callbacks.disconnect({reason:"REJECTED"}),t("REJECTED");if("offer"===a.type)this._setOffer(new window.RTCSessionDescription(a));else if("answer"===a.type)await this._setAnswer(new window.RTCSessionDescription(a));else if("candidate"===a.type&&a.ice){this._traceLog("Received ICE candidate ...",a.ice);const e=new window.RTCIceCandidate(a.ice);this._addIceCandidate(e)}}}catch(e){await this._disconnect(),this._callbacks.disconnect({reason:"SIGNALING-ERROR",error:e})}})}})}_createPeerConnection(){const e={iceServers:this.options.iceServers},a=new window.RTCPeerConnection(e),s=this.stream&&this.stream.getAudioTracks()[0];s&&"recvonly"!==this.options.audio.direction?a.addTrack(s,this.stream):this.options.audio.enabled&&a.addTransceiver("audio",{direction:"recvonly"});const i=this.stream&&this.stream.getVideoTracks()[0];if(i&&"recvonly"!==this.options.video.direction){const e=a.addTrack(i,this.stream),n=this._getTransceiver(a,e);if(this._isVideoCodecSpecified())if(void 0!==n.setCodecPreferences){const e=window.RTCRtpSender.getCapabilities("video"),a=t(this.options.video.codec||"VP9",e.codecs);this._traceLog("video codecs=",a),n.setCodecPreferences(a)}else this._removeCodec=!0}else if(this.options.video.enabled){const e=a.addTransceiver("video",{direction:"recvonly"});if(this._isVideoCodecSpecified())if(void 0!==e.setCodecPreferences){const n=window.RTCRtpSender.getCapabilities("video"),a=t(this.options.video.codec||"VP9",n.codecs);this._traceLog("video codecs=",a),e.setCodecPreferences(a)}else this._removeCodec=!0}a.ontrack=e=>{let t=[];if(this._traceLog("peer.ontrack()",e),"safari"===n()){t.push(e.track);let n=new window.MediaStream(t);this.remoteStream=n}else this.remoteStream=e.streams[0];e.stream=this.remoteStream,this._callbacks.addstream(e)},a.onicecandidate=e=>{this._traceLog("peer.onicecandidate()",e),e.candidate?this._sendIceCandidate(e.candidate):this._traceLog("empty ice event","")},a.oniceconnectionstatechange=async()=>{if(this._traceLog("ICE connection Status has changed to ",a.iceConnectionState),this.connectionState!==a.iceConnectionState)switch(this.connectionState=a.iceConnectionState,this.connectionState){case"connected":this._isOffer=!1,this._callbacks.connect();break;case"disconnected":case"failed":await this._disconnect(),this._callbacks.disconnect({reason:"ICE-CONNECTION-STATE-FAILED"})}},a.onsignalingstatechange=e=>{this._traceLog("signaling state changes:",a.signalingState)},a.ondatachannel=this._onDataChannel.bind(this),this._pc?this._pc=a:(this._pc=a,this._addDataChannel("dataChannel"),this._callbacks.open({authzMetadata:this.authzMetadata}))}async _addDataChannel(e,t){return new Promise((n,a)=>{if(!this._pc)return a("PeerConnection Does Not Ready");if(this._isOffer)return a("PeerConnection Has Local Offer");let s=this._findDataChannel(e);return s?a("DataChannel Already Exists!"):((s=this._pc.createDataChannel(e,t)).onclose=t=>{this._traceLog("datachannel onclosed=>",t),this._dataChannels=this._dataChannels.filter(t=>t.label!=e)},s.onerror=t=>{this._traceLog("datachannel onerror=>",t),this._dataChannels=this._dataChannels.filter(t=>t.label!=e)},s.onmessage=t=>{this._traceLog("datachannel onmessage=>",t.data),t.channelId=e,this._callbacks.data(t)},s.onopen=e=>{this._traceLog("datachannel onopen=>",e)},this._dataChannels.push(s),n())})}_onDataChannel(e){if(this._traceLog("on data channel",e),!this._pc)return;let t=e.channel,n=e.channel.label;e.channel&&(!n||n.length<1||(t.onopen=async e=>{this._traceLog("datachannel onopen=>",e)},t.onclose=async e=>{this._traceLog("datachannel onclosed=>",e)},t.onerror=async e=>{this._traceLog("datachannel onerror=>",e)},t.onmessage=e=>{this._traceLog("datachannel onmessage=>",e.data),e.channelId=n,this._callbacks.data(e)},this._findDataChannel(n)?this._dataChannels=this._dataChannels.map(e=>e.label==n?t:e):this._dataChannels.push(e.channel)))}async _sendOffer(){if(!this._pc)return;"safari"===n()&&(this.options.video.enabled&&"sendrecv"===this.options.video.direction&&this._pc.addTransceiver("video",{direction:"recvonly"}),this.options.audio.enabled&&"sendrecv"===this.options.audio.direction&&this._pc.addTransceiver("audio",{direction:"recvonly"}));let e=await this._pc.createOffer({offerToReceiveAudio:this.options.audio.enabled&&"sendonly"!==this.options.audio.direction,offerToReceiveVideo:this.options.video.enabled&&"sendonly"!==this.options.video.direction});if(this._removeCodec&&this.options.video.codec){["VP8","VP9","H264"].forEach(t=>{this.options.video.codec!==t&&(e.sdp=function(e,t){const n=e=>{const a=new RegExp("(a=rtpmap:(\\d*) "+t+"/90000\\r\\n)"),s=e.match(a);if(null==s||s.length<=2)return e;const i=s[2];let o=e.replace(a,"");const c=new RegExp("(a=rtcp-fb:"+i+".*\r\n)","g");o=o.replace(c,"");const r=new RegExp("(a=fmtp:"+i+".*\r\n)","g");o=o.replace(r,"");const d=new RegExp("(a=fmtp:(\\d*) apt="+i+"\\r\\n)"),h=o.match(d);let l="";if(null!=h&&h.length>=3){l=h[2],o=o.replace(d,"");const e=new RegExp("(a=rtpmap:"+l+".*\r\n)","g");o=o.replace(e,"")}let _=/(m=video.*\r\n)/;const p=o.match(_);if(null!=p){const e=p[0].substring(0,p[0].length-2).split(" ");let t=e[0];e.forEach((e,n)=>{0!==n&&e!=i&&e!=l&&(t+=" "+e)}),t+="\r\n",o=o.replace(_,t)}return n(o)};return n(e)}(e.sdp,t))})}this._traceLog("create offer sdp, sdp=",e.sdp),await this._pc.setLocalDescription(e),this._sendSdp(this._pc.localDescription),this._isOffer=!0}_isVideoCodecSpecified(){return this.options.video.enabled&&null!==this.options.video.codec}async _createAnswer(){if(this._pc)try{let e=await this._pc.createAnswer();this._traceLog("create answer sdp, sdp=",e.sdp),await this._pc.setLocalDescription(e),this._sendSdp(this._pc.localDescription)}catch(e){await this._disconnect(),this._callbacks.disconnect({reason:"CREATE-ANSWER-ERROR",error:e})}}async _setAnswer(e){await this._pc.setRemoteDescription(e),this._traceLog("set answer sdp=",e.sdp)}async _setOffer(e){this._createPeerConnection();try{await this._pc.setRemoteDescription(e),this._traceLog("set offer sdp=",e.sdp),await this._createAnswer()}catch(e){await this._disconnect(),this._callbacks.disconnect({reason:"SET-OFFER-ERROR",error:e})}}async _addIceCandidate(e){try{this._pc&&await this._pc.addIceCandidate(e)}catch(t){this._traceLog("invalid ice candidate",e)}}_sendIceCandidate(e){const t={type:"candidate",ice:e};this._sendWs(t)}_sendSdp(e){this._sendWs(e)}_sendWs(e){this._ws&&this._ws.send(JSON.stringify(e))}_getTransceiver(e,t){let n=null;if(e.getTransceivers().forEach(e=>{e.sender!=t&&e.receiver!=t||(n=e)}),!n)throw new Error("invalid transceiver");return n}_findDataChannel(e){return this._dataChannels.find(t=>t.label==e)}async _closeDataChannel(e){return new Promise((t,n)=>{if(!e)return t();if("closed"===e.readyState)return t();e.onclose=null;const a=setInterval(()=>e?"closed"===e.readyState?(clearInterval(a),t()):void 0:(clearInterval(a),n("DataChannel Closing Error")),800);e&&e.close()})}async _closePeerConnection(){return new Promise((e,t)=>{if("safari"===n()&&this._pc)return this._pc.oniceconnectionstatechange=null,this._pc.close(),this._pc=null,e();if(!this._pc)return e();if(this._pc&&"closed"==this._pc.signalingState)return e();this._pc.oniceconnectionstatechange=null;const a=setInterval(()=>this._pc?this._pc&&"closed"==this._pc.signalingState?(clearInterval(a),e()):void 0:(clearInterval(a),t("PeerConnection Closing Error")),800);this._pc.close()})}async _closeWebSocketConnection(){return new Promise((e,t)=>{if(!this._ws)return e();if(this._ws&&3===this._ws.readyState)return e();this._ws.onclose=()=>{};const n=setInterval(()=>this._ws?3===this._ws.readyState?(clearInterval(n),e()):void 0:(clearInterval(n),t("WebSocket Closing Error")),800);this._ws&&this._ws.close()})}_traceLog(e,t){this.debug&&function(e,t){let a="";window.performance&&(a="[Ayame "+(window.performance.now()/1e3).toFixed(3)+"]"),"edge"===n()?console.log(a+" "+e+"\n",t):console.info(a+" "+e+"\n",t)}(e,t)}}class s extends a{constructor(e,t,n,a=!1){super(e,t,n,a)}async connect(e,t=null){if(this._ws||this._pc)throw this._traceLog("connection already exists"),new Error("Connection Already Exists!");this.stream=e,this.authnMetadata=t,await this._signaling()}async addDataChannel(e,t=null){await this._addDataChannel(e,t)}async removeDataChannel(e){this._traceLog("datachannel remove=>",e);const t=this._findDataChannel(e);if(!t||"open"!==t.readyState)throw new Error("data channel is not exist or open");await this._closeDataChannel(t)}sendData(e,t="dataChannel"){this._traceLog("datachannel sendData=>",e);const n=this._findDataChannel(t);if(!n||"open"!==n.readyState)throw new Error("datachannel is not open");n.send(e)}async disconnect(){await this._disconnect()}}const i={audio:{direction:"sendrecv",enabled:!0},video:{direction:"sendrecv",enabled:!0,codec:null},iceServers:[{urls:"stun:stun.l.google.com:19302"}],clientId:function(e){for(var t=[];e--;)t.push("0123456789".charAt(Math.floor(Math.random()*"0123456789".length)));return t.join("")}(17)};e.connection=function(e,t,n=i,a=!1){return new s(e,t,n,a)},e.defaultOptions=i,e.version=function(){return process.version},Object.defineProperty(e,"__esModule",{value:!0})});