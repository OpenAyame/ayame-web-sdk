!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Ayame={})}(this,function(e){"use strict";function t(){const e=window.navigator.userAgent.toLocaleLowerCase();return-1!==e.indexOf("edge")?"edge":-1!==e.indexOf("chrome")&&-1===e.indexOf("edge")?"chrome":-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")?"safari":-1!==e.indexOf("opera")?"opera":-1!==e.indexOf("firefox")?"firefox":void 0}class i{constructor(e,t,i,s=!1){this.debug=s,this.roomId=t,this.signalingUrl=e,this.options=i,this._isNegotiating=!1,this.stream=null,this._pc=null,this.authnMetadata=null,this._callbacks={connect:()=>{},disconnect:()=>{},addstream:()=>{},removestream:()=>{}}}on(e,t){e in this._callbacks&&(this._callbacks[e]=t)}async connect(e,t=null){if(this._ws||this._pc)throw this._traceLog("connection already exists"),new Error("Connection Already Exists!");return this.stream=e,this.authnMetadata=t,await this._signaling(),e}async disconnect(){const e=new Promise((e,t)=>{if(!this._pc)return e();if(this._pc&&"closed"==this._pc.signalingState)return e();this._pc.oniceconnectionstatechange=()=>{};const i=setInterval(()=>this._pc?this._pc&&"closed"==this._pc.signalingState?(clearInterval(i),e()):void 0:(clearInterval(i),t("PeerConnection Closing Error")),800);this._pc.close()}),t=new Promise((e,t)=>{if(!this._ws)return e();if(this._ws&&3===this._ws.readyState)return e();this._ws.onclose=()=>{};const i=setInterval(()=>this._ws?3===this._ws.readyState?(clearInterval(i),e()):void 0:(clearInterval(i),t("WebSocket Closing Error")),800);this._ws&&this._ws.close()});this.stream&&this.stream.getTracks().forEach(e=>{e.stop()}),this.remoteStreamId=null,this.stream=null,this.authnMetadata=null,this._isNegotiating=!1,await Promise.all([t,e]),this._ws=null,this._pc=null}async _signaling(){return new Promise((e,t)=>this._ws?t("WebSocket Connnection Already Exists!"):(this._ws=new WebSocket(this.signalingUrl),this._ws.onopen=()=>{const e={type:"register",roomId:this.roomId,clientId:this.options.clientId,authnMetadata:void 0};null!==this.authnMetadata&&(e.authnMetadata=this.authnMetadata),this._sendWs(e),this._ws&&(this._ws.onmessage=async e=>{try{if("string"!=typeof e.data)return;const t=JSON.parse(e.data);if("ping"===t.type)this._sendWs({type:"pong"});else if("close"===t.type)this._callbacks.close(e);else if("accept"===t.type)this._pc||(this._pc=this._createPeerConnection(!0)),this._callbacks.connect({authzMetadata:t.authzMetadata}),this._ws&&(this._ws.onclose=async e=>{await this.disconnect(),this._callbacks.disconnect({reason:"WS-CLOSED",event:e})});else if("reject"===t.type)await this.disconnect(),this._callbacks.disconnect({reason:"REJECTED"});else if("offer"===t.type)this._setOffer(t);else if("answer"===t.type)await this._setAnswer(t);else if("candidate"===t.type&&t.ice){this._traceLog("Received ICE candidate ...",t.ice);const e=new window.RTCIceCandidate(t.ice);this._addIceCandidate(e)}}catch(e){await this.disconnect(),this._callbacks.disconnect({reason:"SIGNALING-ERROR",error:e})}})},this._ws&&(this._ws.onclose=async e=>{await this.disconnect(),this._callbacks.disconnect(e)}),e()))}_createPeerConnection(e){const i={iceServers:this.options.iceServers},s=new window.RTCPeerConnection(i),n=this.stream&&this.stream.getAudioTracks()[0];if(n&&"recvonly"!==this.options.audio.direction){const e=s.addTrack(n,this.stream),i=this._getTransceiver(s,e);if(this._isAudioCodecSpecified()){const e=window.RTCRtpSender.getCapabilities("audio"),s=function(e,i){if("chrome"!==t())throw new Error("codec 指定は chrome canary でのみ利用できます");let s="";s="OPUS"===e?"audio/opus":"G722"===e?"audio/G722":"PCMU"===e?"audio/PCMU":"PCMA"===e?"audio/PCMA":`video/${e}`;const n=i.filter(e=>e.mimeType==s);if(n.length<1)throw new Error("invalid audio codec type");return n}(this.options.audio.codec||"OPUS",e.codecs);this._traceLog("audio codecs=",s),i.setCodecPreferences(s)}}const o=this.stream&&this.stream.getVideoTracks()[0];if(o&&"recvonly"!==this.options.video.direction){const e=s.addTrack(o,this.stream),i=this._getTransceiver(s,e);if(this._isVideoCodecSpecified()){const e=window.RTCRtpSender.getCapabilities("video"),s=function(e,i){if("chrome"!==t())throw new Error("codec 指定は chrome canary でのみ利用できます");let s="";s="VP8"===e?"video/VP8":"VP9"===e?"video/VP9":"H264"===e?"video/H264":`video/${e}`;const n=i.filter(e=>e.mimeType==s);if(n.length<1)throw new Error("invalid video codec type");return n}(this.options.video.codec||"VP9",e.codecs);this._traceLog("video codecs=",s),i.setCodecPreferences(s)}}let c=[];return s.ontrack=e=>{this._traceLog("peer.ontrack()",e),c.push(e.track);let t=new window.MediaStream(c);this.remoteStreamId=t.id,e.stream=t,this._callbacks.addstream(e)},s.onicecandidate=e=>{this._traceLog("peer.onicecandidate()",e),e.candidate?this._sendIceCandidate(e.candidate):this._traceLog("empty ice event","")},s.oniceconnectionstatechange=async()=>{switch(this._traceLog("ICE connection Status has changed to ",s.iceConnectionState),s.iceConnectionState){case"connected":this._isNegotiating=!1;break;case"failed":await this.disconnect(),this._callbacks.disconnect({reason:"ICE-CONNECTION-STATE-FAILED"})}},s.onnegotiationneeded=async()=>{if(this._traceLog("peer.onnegotiationneeded",""),!this._isNegotiating&&"stable"===this._pc.signalingState)try{if(this._isNegotiating=!0,e){const e=await s.createOffer({offerToReceiveAudio:this.options.audio.enabled&&"sendonly"!==this.options.audio.direction,offerToReceiveVideo:this.options.video.enabled&&"sendonly"!==this.options.video.direction});this._traceLog("create offer sdp, sdp=",e.sdp),await s.setLocalDescription(e),this._sendSdp(s.localDescription),this._isNegotiating=!1}}catch(e){await this.disconnect(),this._callbacks.disconnect({reason:"NEGOTIATION-ERROR",error:e})}},s.onsignalingstatechange=e=>{this._traceLog("signaling state changes:",s.signalingState)},s}_isVideoCodecSpecified(){return void 0!==window.RTCRtpSender.getCapabilities&&("recvonly"!==this.options.video.direction&&(this.options.video.enabled&&null!==this.options.video.codec))}_isAudioCodecSpecified(){return void 0!==window.RTCRtpSender.getCapabilities&&("recvonly"!==this.options.audio.direction&&(this.options.audio.enabled&&null!==this.options.audio.codec))}async _createAnswer(){if(this._pc)try{let e=await this._pc.createAnswer();this._traceLog("create answer sdp, sdp=",e.sdp),await this._pc.setLocalDescription(e),this._sendSdp(this._pc.localDescription)}catch(e){await this.disconnect(),this._callbacks.disconnect({reason:"CREATE-ANSWER-ERROR",error:e})}}async _setAnswer(e){await this._pc.setRemoteDescription(e)}async _setOffer(e){this._pc=this._createPeerConnection(!1);try{await this._pc.setRemoteDescription(e),await this._createAnswer()}catch(e){await this.disconnect(),this._callbacks.disconnect({reason:"SET-OFFER-ERROR",error:e})}}async _addIceCandidate(e){try{this._pc&&await this._pc.addIceCandidate(e)}catch(t){this._traceLog("invalid ice candidate",e)}}_sendIceCandidate(e){const t={type:"candidate",ice:e};this._sendWs(t)}_sendSdp(e){this._sendWs(e)}_sendWs(e){this._ws&&this._ws.send(JSON.stringify(e))}_traceLog(e,i){this.debug&&function(e,i){let s="";window.performance&&(s="[Ayame "+(window.performance.now()/1e3).toFixed(3)+"]"),"edge"===t()?console.log(s+" "+e+"\n",i):console.info(s+" "+e+"\n",i)}(e,i)}_getTransceiver(e,t){let i=null;if(e.getTransceivers().forEach(e=>{e.sender!=t&&e.receiver!=t||(i=e)}),!i)throw new Error("invalid transceiver");return i}}const s={audio:{direction:"sendrecv",enabled:!0,codec:null},video:{direction:"sendrecv",enabled:!0,codec:null},iceServers:[{urls:"stun:stun.l.google.com:19302"}],clientId:function(e){for(var t=[];e--;)t.push("0123456789".charAt(Math.floor(Math.random()*"0123456789".length)));return t.join("")}(17)};e.connection=function(e,t,n=s,o=!1){return new i(e,t,n,o)},e.defaultOptions=s,e.version=function(){return process.version},Object.defineProperty(e,"__esModule",{value:!0})});